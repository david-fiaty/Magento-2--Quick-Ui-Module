/**
 * Naxero.com
 * Professional ecommerce integrations for Magento
 *
 * PHP version 7
 *
 * @category  Magento2
 * @package   Naxero
 * @author    Platforms Development Team <contact@naxero.com>
 * @copyright Naxero.com
 * @license   https://opensource.org/licenses/mit-license.html MIT License
 * @link      https://www.naxero.com
 */

define(["jquery","Naxero_Translation/js/translation/filters","mage/translate","mage/cookies"],function(e,t,a){"use strict";const i="translation-paging-filter";return{initCache:function(){var t={};return{_:function(a){return void 0===t[a]&&(t[a]=e(a)),t[a]}}},callMethod:function(e,t,a){"function"==typeof e[t]&&(void 0===a?e[t]():e[t](a))},showMessage:function(t,i,r){this.clearMessages(t);var o=e('<div class="message"></div>');o.addClass("message-"+i+" "+i),o.append("<div>"+a(r)+"</div>"),o.insertBefore(".tabulator-header"),o.show()},clearMessages:function(t){e(".message").hide().remove()},getDownloadFileName:function(){return"trans_"+Date.now()+".csv"},setPaging:function(t,a,r){r=r||e.cookie(i)||50;t.cache._(a).tabulator("setPageSize",r),e.cookie(i,r),t.cache._("."+i).val(r)},getDetailColumns:function(e){var t=this;return[{title:a("File Id"),field:"file_id",sorter:"number",visible:!1},{title:a("#"),field:"index",sorter:"number",width:70,visible:!1},{title:a("Read"),field:"is_readable",sorter:"number",formatter:"tickCross",width:85,visible:!1},{title:a("Write"),field:"is_writable",sorter:"number",formatter:"tickCross",width:90,visible:!1},{title:a("Is error"),field:"is_error",sorter:"number",width:90,visible:!1},{title:a("Row Id"),field:"row_id",sorter:"number",visible:!1},{title:a("Key"),field:"key",sorter:"string",headerFilter:"input",headerFilterPlaceholder:a("Search..."),formatter:"textarea",editor:"input"},{title:a("Value"),field:"value",sorter:"string",headerFilter:"input",headerFilterPlaceholder:a("Search..."),formatter:"textarea",editor:"input"},{title:"",field:"delete",width:50,headerSort:!1,formatter:function(e,t,a){return"&ominus;"},cellClick:function(a,i){var r=i.getRow(),o=r.getData();t.deleteRow(e,{fileId:o.file_id,rowId:o.row_id}),r.delete()}}]},getData:function(a){var i=this,r={form_key:window.FORM_KEY};e.ajax({type:"POST",url:a.options.dataUrl,dataType:"json",showLoader:!0,data:r,success:function(e){i.prepareData(a,a.options.targetTable,e),i.setPaging(a,a.options.targetTable),t.build(a,e),t.addEvents(a),e.error_data&&i.displayFileErrors(a,e)},error:function(e,t,r){i.showMessage(a,"error",r)}})},prepareData:function(e,t,i){var r=i.table_data.length,o=i.error_data?i.error_data.length:0;if(this.setRowsCount(e,t,r,o),e.cache._(t).find(".tabulator-tableHolder .no-results").remove(),e.cache._(t).tabulator("clearData"),0!=r)e.cache._(t).tabulator("setData",i.table_data);else{var s='<div class="no-results">';s+=a("No results found."),s+="</div>",e.cache._(t).find(".tabulator-tableHolder").prepend(s)}},setRowsCount:function(e,t,i,r){var o='<div class="translation-rows-count">';o+="<span>"+a("Rows")+":&nbsp;"+i+"</span>",o+='<span class="err">&nbsp;-&nbsp;',o+=a("Errors")+":&nbsp;"+r+"</span>&nbsp;",o+="</div>",e.cache._(t).find(".translation-rows-count").remove(),e.cache._(t).prepend(o)},createFile:function(t,a){var i=this,r=a;r.form_key=window.FORM_KEY,e.ajax({type:"POST",url:t.options.newFileUrl,dataType:"json",showLoader:!0,data:r,success:function(e){var a=e.success?"success":"error";i.showMessage(t,a,e.message),i.getData(t)},error:function(e,a,r){i.showMessage(t,"error",r)}})},updateFileIndex:function(t,a){var i=this,r={update_mode:a,form_key:window.FORM_KEY};e.ajax({type:"POST",url:t.options.scanUrl,dataType:"json",showLoader:!0,data:r,success:function(e){var a=e.success?"success":"error";i.showMessage(t,a,e.message),i.getData(t)},error:function(e,a,r){i.showMessage(t,"error",r)}})},updateEntityData:function(t,a){var i=this,r=t.options.detailViewUrl,o={row_content:a.rowContent,action:"update_data",file_id:a.fileId,form_key:window.FORM_KEY};e.ajax({type:"POST",url:r,data:o,dataType:"json",success:function(e){},error:function(e,a,r){i.showMessage(t,"error",r)}})},deleteRow:function(t,a){var i=this,r={action:"delete_row",file_id:a.fileId,row_id:a.rowId,form_key:window.FORM_KEY};e.ajax({type:"POST",url:t.options.detailViewUrl,data:r,dataType:"json",showLoader:!0,success:function(e){},error:function(e,a,r){i.showMessage(t,"error",r)}}),t.rowsCountEdited=!0},deleteFile:function(t,a){var i=this,r={action:"delete_file",file_id:a.file_id,form_key:window.FORM_KEY};e.ajax({type:"POST",url:t.options.detailViewUrl,data:r,dataType:"json",showLoader:!0,success:function(e){var a=e.success?"success":"error";i.showMessage(t,a,e.message)},error:function(e,a,r){i.showMessage(t,"error",r)}})},importFile:function(t,a,i){var r=this,o=new FormData;o.append("new_file_import",a);var s=t.options.detailViewUrl;s+="?isAjax=true&action=import_data&file_id="+i,s+="&form_key="+window.FORM_KEY,e.ajax({type:"POST",url:s,data:o,contentType:!1,processData:!1,showLoader:!0,success:function(e){var a=e.success?"success":"error";r.showMessage(t,a,e.message),r.getRowDetails(t,i,!1)},error:function(e,a,i){r.showMessage(t,"error",i)}})},loadRowDetails:function(e,t,a){var i=this;e.cache._(e.options.detailView).tabulator({langs:e.options.localeData,pagination:"local",layout:"fitColumns",responsiveLayout:!0,height:"100%",resizableRows:!0,columns:i.getDetailColumns(e),cellEdited:function(t){i.handleCellEdit(e,t,!0)},rowClick:function(t,a){i.handleCellEdit(e,a,!1)},initialSort:[{column:"index",dir:"asc"}]}),e.cache._(e.options.detailViewFilePath).text(t.file_path),this.getRowDetails(e,t.file_id,a),this.togglePanes(e,t.file_id)},getRowDetails:function(t,a,r){var o=this,s={action:"get_data",file_id:a,form_key:window.FORM_KEY,is_log_view:r};e.ajax({type:"POST",url:t.options.detailViewUrl,dataType:"json",showLoader:!0,data:s,success:function(a){o.prepareData(t,t.options.detailView,a),o.setPaging(t,t.options.detailView),t.cache._("."+i).on("change",function(){let a=e(this).find(":selected").val();o.setPaging(t,t.options.detailView,a)}),a.error_data&&o.displayRowErrors(t,a)},error:function(e,a,i){o.showMessage(t,"error",i)}})},handleRowView:function(e,t){var i=t.getData();"1"==i.is_readable?this.loadRowDetails(e,i,!1):alert(a("This file is not readable. Please check the file permissions."))},handleCellEdit:function(e,t,i){var r=(i?t.getRow():t).getData();"1"==r.is_writable?this.updateEntityData(e,{fileId:r.file_id,rowContent:r}):alert(a("This file is not writable. Please check the file permissions."))},displayRowErrors:function(e,t){var a=e.cache._(e.options.detailView).tabulator("getRows");this.displayErrors(a,t)},displayFileErrors:function(e,t){var a=e.cache._(e.options.targetTable).tabulator("getRows");this.displayErrors(a,t)},displayErrors(e,t){e.forEach(function(e){var a=e.getData().index;-1!=t.error_data.indexOf(a)&&e.getElement().css({"background-color":"#FF9900"})})},togglePanes:function(e,t){e.isListView?(e.cache._("#translation-table-list").animate({left:"-50px"}),e.cache._("#translation-table-list").hide(),e.cache._("#translation-table-detail").show(),e.isListView=!1,e.detailViewId=t):(e.cache._("#translation-table-detail").hide(),e.cache._("#translation-table-list").animate({left:"0px"}),e.cache._("#translation-table-list").show(),e.isListView=!0,e.detailViewId=0)}}});